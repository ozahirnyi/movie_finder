name: Deploy to Lightsail via CodeDeploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    # Only runs if CI passed successfully (for push to main)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create deployment package
        run: |
          echo "Creating deployment package..."
          # Use git archive to create a clean package
          git archive --format=tar.gz HEAD > deployment.tar.gz
          
          echo "Deployment package created: $(ls -lh deployment.tar.gz)"
          echo "Verifying monitoring files are in the bundle (for Grafana/Loki logs on prod)..."
          tar -tzf deployment.tar.gz | grep -E '^docker-compose\.monitoring\.yml$|^monitoring/' | head -20
          if ! tar -tzf deployment.tar.gz | grep -q '^docker-compose\.monitoring\.yml$'; then
            echo "ERROR: docker-compose.monitoring.yml missing from bundle - logs will not work on prod"
            exit 1
          fi
          if ! tar -tzf deployment.tar.gz | grep -q '^monitoring/'; then
            echo "ERROR: monitoring/ directory missing from bundle - logs will not work on prod"
            exit 1
          fi
          echo "Monitoring files present in bundle."

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          S3_KEY="movie-finder/deployments/${TIMESTAMP}-${COMMIT_SHA}.tar.gz"
          
          echo "Uploading to S3: s3://${{ secrets.CODEDEPLOY_S3_BUCKET }}/${S3_KEY}"
          
          aws s3 cp deployment.tar.gz "s3://${{ secrets.CODEDEPLOY_S3_BUCKET }}/${S3_KEY}"
          
          # Save S3 location for next step
          echo "S3_KEY=${S3_KEY}" >> $GITHUB_ENV

      - name: Create CodeDeploy deployment
        id: deploy
        run: |
          echo "Creating CodeDeploy deployment..."
          
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ secrets.CODEDEPLOY_APP_NAME }} \
            --deployment-group-name ${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }} \
            --s3-location bucket=${{ secrets.CODEDEPLOY_S3_BUCKET }},key=${S3_KEY},bundleType=tgz \
            --deployment-config-name CodeDeployDefault.OneAtATime \
            --description "Deployment from GitHub Actions - Commit ${GITHUB_SHA:0:7}" \
            --query 'deploymentId' \
            --output text)
          
          echo "deployment_id=${DEPLOYMENT_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment created: ${DEPLOYMENT_ID}"

      - name: Wait for deployment
        id: wait_deploy
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          echo "Waiting for deployment ${DEPLOYMENT_ID} to complete..."
          
          aws deploy wait deployment-successful \
            --deployment-id ${DEPLOYMENT_ID} \
            --output text || {
            echo "‚ùå Deployment failed!"
            exit 1
          }
          
          echo "‚úÖ Deployment completed successfully!"

      - name: Get deployment details
        if: failure()
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          
          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "=========================================="
            echo "üìã Deployment Details: ${DEPLOYMENT_ID}"
            echo "=========================================="
            
            echo ""
            echo "üìä Deployment Status:"
            aws deploy get-deployment \
              --deployment-id ${DEPLOYMENT_ID} \
              --query 'deploymentInfo.[status,statusMessage,creator,createTime]' \
              --output table
            
            echo ""
            echo "üìù Deployment Events (last 20):"
            aws deploy list-deployment-instances \
              --deployment-id ${DEPLOYMENT_ID} \
              --query 'instancesList' \
              --output table || echo "No instances found"
            
            echo ""
            echo "üîç Instance Status:"
            aws deploy get-deployment-instance \
              --deployment-id ${DEPLOYMENT_ID} \
              --instance-id $(aws deploy list-deployment-instances --deployment-id ${DEPLOYMENT_ID} --query 'instancesList[0]' --output text 2>/dev/null || echo "") \
              --query 'instanceSummary.[instanceId,status,lifecycleEvents[*].[lifecycleEventName,status,diagnostics]]' \
              --output json 2>/dev/null || echo "Could not get instance details"
            
            echo ""
            echo "üí° To see full logs, SSH to the instance and run:"
            echo "   sudo tail -100 /opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log"
            echo ""
            echo "   Or check CodeDeploy Console:"
            echo "   https://console.aws.amazon.com/codesuite/codedeploy/deployments/${DEPLOYMENT_ID}"
          fi

      - name: Health check
        run: |
          echo "‚è≥ Waiting for application to start..."
          sleep 10
          
          echo "üè• Running health check..."
          curl -f --retry 5 --retry-delay 5 --retry-all-errors ${{ secrets.LIGHTSAIL_URL }} || {
            echo "‚ùå Health check failed! Application is not responding."
            exit 1
          }
          
          echo "‚úÖ Health check passed!"
