name: Deploy to Lightsail

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    # Only runs if CI passed successfully (for push to main)
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.LIGHTSAIL_SSH_PRIVATE_KEY }}

      - name: Add Lightsail host to known hosts
        run: |
          echo "Connecting to Lightsail host: ${{ secrets.LIGHTSAIL_HOST }}"
          echo "Running network diagnostics..."
          
          # Test DNS resolution
          if host ${{ secrets.LIGHTSAIL_HOST }} > /dev/null 2>&1; then
            echo "âœ“ DNS resolution successful"
          else
            echo "âœ— DNS resolution failed"
          fi
          
          # Test connectivity on port 22
          if timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.LIGHTSAIL_HOST }}/22" 2>/dev/null; then
            echo "âœ“ Port 22 is reachable"
          else
            echo "âœ— Port 22 is NOT reachable"
          fi
          
          # Try ssh-keyscan with verbose output
          echo "Attempting ssh-keyscan..."
          ssh-keyscan -v -t rsa,ecdsa,ed25519 ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo ""
            echo "ERROR: Cannot reach host. Please verify:"
            echo "1. Lightsail instance is running"
            echo "2. Firewall allows port 22 from 0.0.0.0/0 (or GitHub Actions IP ranges)"
            echo "3. LIGHTSAIL_HOST secret contains correct IP/hostname"
            echo "4. Security group allows SSH access"
            exit 1
          }
          echo "âœ“ Host key added successfully"

      - name: Deploy to Lightsail
        env:
          LIGHTSAIL_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          LIGHTSAIL_USER: ${{ secrets.LIGHTSAIL_USER }}
          LIGHTSAIL_APP_DIR: ${{ secrets.LIGHTSAIL_APP_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no ${LIGHTSAIL_USER}@${LIGHTSAIL_HOST} << ENDSSH
            set -e
            cd ${LIGHTSAIL_APP_DIR:-/home/ec2-user/movie_finder}
            
            echo "ðŸ”„ Fetching latest changes from Git..."
            git fetch origin
            git reset --hard origin/main
            
            echo "ðŸ”¨ Rebuilding Docker containers..."
            sudo docker compose -f docker-compose.lightsail.yml build
            
            echo "ðŸ”„ Applying migrations..."
            sudo docker compose -f docker-compose.lightsail.yml run --rm web poetry run python manage.py migrate --noinput
            
            echo "ðŸ“¦ Collecting static files..."
            sudo docker compose -f docker-compose.lightsail.yml run --rm web poetry run python manage.py collectstatic --noinput
            
            echo "ðŸš€ Restarting services..."
            sudo docker compose -f docker-compose.lightsail.yml up -d
            
            echo "â³ Waiting for services to be ready..."
            sleep 10
            
            echo "âœ… Checking container status..."
            sudo docker compose -f docker-compose.lightsail.yml ps
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: Health check
        run: |
          echo "â³ Waiting for application to start..."
          sleep 5
          echo "ðŸ¥ Running health check..."
          curl -f --retry 3 --retry-delay 5 --retry-all-errors ${{ secrets.LIGHTSAIL_URL }} || {
            echo "âŒ Health check failed! Application is not responding."
            exit 1
          }
          echo "âœ… Health check passed!"
